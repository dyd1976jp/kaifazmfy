---
id: 004
name: 本地LLM翻译
status: open
created: 2025-09-05T06:36:20Z
updated: 2025-09-05T06:36:20Z
depends_on: [001]
parallel: true
effort: L
assignee: null
progress: 0%
epic: video-subtitle-translate
---

# Task: 本地LLM翻译

## Overview
构建多后端LLM翻译模块，支持Ollama和LM Studio两种本地运行时，提供统一API接口和批处理优化，确保高质量的字幕翻译功能。

## Technical Requirements

### Core Components
- **多后端支持**: 支持Ollama和LM Studio两种本地LLM运行时
- **统一API**: 抽象层统一处理不同后端的API差异
- **自动检测**: 自动检测可用的LLM服务并选择最优后端
- **批处理优化**: 批量翻译减少API调用次数，提高效率
- **错误重试**: 网络异常和模型错误的自动重试机制

### Implementation Details
- **Ollama Client**: HTTP API集成，支持模型自动下载和切换
- **LM Studio Client**: REST API集成，支持已加载模型检测
- **Prompt Engineering**: 优化翻译提示词，确保质量和格式一致性
- **Result Caching**: LRU缓存机制避免重复翻译
- **Progress Tracking**: 批处理进度监控和估时功能

## Acceptance Criteria

### Backend Integration
- [ ] Ollama HTTP API客户端实现，支持所有常用翻译模型
- [ ] LM Studio REST API客户端实现，兼容OpenAI API格式
- [ ] 统一的翻译接口抽象，隐藏后端差异
- [ ] 服务可用性自动检测和健康检查

### Translation Quality
- [ ] 多语言翻译支持（中英日韩至少4种语言对）
- [ ] Prompt模板优化，BLEU评分 > 0.4
- [ ] 上下文保持，支持长文本分段翻译
- [ ] 专业术语一致性检查

### Performance & Reliability
- [ ] 批处理支持，单次最多处理50条字幕
- [ ] 指数退避重试机制，最多重试3次
- [ ] 翻译缓存机制，缓存命中率 > 80%
- [ ] 内存使用优化，峰值 < 2GB

### Configuration & Monitoring
- [ ] 配置文件支持，可自定义后端优先级和模型选择
- [ ] 详细日志记录，包含API调用统计和错误追踪
- [ ] 性能指标收集，翻译速度和质量监控
- [ ] 命令行参数支持模型和后端手动指定

## Files to Modify/Create
- `src/translation/backends/` - 后端实现目录
- `src/translation/backends/ollama.py` - Ollama客户端
- `src/translation/backends/lmstudio.py` - LM Studio客户端  
- `src/translation/backends/base.py` - 统一接口定义
- `src/translation/translator.py` - 翻译管理器
- `src/translation/prompts.py` - 提示词模板
- `src/translation/cache.py` - 缓存机制
- `tests/test_translation/` - 翻译模块测试

## Dependencies
- **Depends on**: Task 001 (项目搭建和配置)
- **External**: Ollama 或 LM Studio 服务运行
- **Models**: Qwen2.5/Llama3 等多语言翻译模型

## Testing Strategy
- **单元测试**: 每个后端客户端独立测试，覆盖正常和异常情况
- **集成测试**: 端到端翻译流程测试，使用真实模型
- **性能测试**: 批处理性能和内存使用基准测试  
- **质量测试**: BLEU评分和人工评估相结合

## Estimated Effort
**Size**: L (3-4 days)
- Day 1: 统一接口设计和Ollama客户端实现
- Day 2: LM Studio客户端和自动检测功能
- Day 3: 批处理优化和缓存机制
- Day 4: 测试完善和性能调优

## Notes
- 可与Task 001并行开发，是独立的功能模块
- 后端检测逻辑需要考虑不同平台的差异
- 翻译质量直接影响最终用户体验，需要重点测试