---
id: 005
name: 双语字幕生成
status: open
created: 2025-09-05T06:36:20Z
updated: 
depends_on: [003, 004]
parallel: false
effort: M
assignee: null
progress: 0%
epic: video-subtitle-translate
---

# Task: 双语字幕生成

## Overview
整合语音识别和翻译模块，实现标准双语SRT字幕文件生成，支持多种语言布局、字符数限制和时间轴精度保持。

## Technical Requirements

### Core Components
- **SRT解析器**: 解析和生成标准SRT格式文件，符合规范
- **双语格式化**: 上下行布局，翻译在上，原文在下
- **字符数限制**: 根据语言特性调整字符数限制（中25/英50/日25）
- **时间轴保持**: 保持原始Whisper生成的精确时间轴
- **编码处理**: 支持UTF-8和特殊字符正确显示

### Implementation Details
- **格式标准化**: 严格遵循SRT格式规范，兼容主流播放器
- **长度优化**: 智能断行和长度控制，提高可读性
- **质量检测**: 检测翻译质量异常和格式错误
- **输出选项**: 支持单语、双语、仅翻译三种输出模式

## Acceptance Criteria

### SRT Format Compliance
- [ ] 标准SRT格式输出，包含序号、时间轴、文本内容
- [ ] 时间轴格式正确（HH:MM:SS,mmm --> HH:MM:SS,mmm）
- [ ] UTF-8编码支持，正确处理中文、日文、韩文等多字节字符
- [ ] 主流播放器兼容性验证（VLC、MPC-HC、PotPlayer）

### Bilingual Layout
- [ ] 双语字幕上下行布局实现
- [ ] 翻译文本在上，原文在下的标准布局
- [ ] 空字幕处理，避免显示空行
- [ ] 长字幕智能断行，保持视觉平衡

### Character Limits
- [ ] 中文字幕每行最多25字符
- [ ] 英文字幕每行最多50字符
- [ ] 日文字幕每行最多25字符
- [ ] 韩文字幕每行最多25字符
- [ ] 超长字幕自动分割到下一个时间段

### Timeline Preservation
- [ ] 保持Whisper原始时间轴精度（毫秒级）
- [ ] 时间轴连续性检查，避免重叠和间隙
- [ ] 最小显示时间限制（0.5秒）
- [ ] 最大显示时间限制（7秒）

### Output Options
- [ ] 单语字幕输出（原文或译文）
- [ ] 双语字幕输出（上译下原）
- [ ] 仅翻译输出（纯译文）
- [ ] 自定义布局选项（上原下译）

## Files to Modify/Create
- `src/subtitle/srt_parser.py` - SRT格式解析和生成
- `src/subtitle/formatter.py` - 双语格式化器
- `src/subtitle/validator.py` - 字幕质量检查
- `src/subtitle/merger.py` - STT和翻译结果合并
- `src/subtitle/utils.py` - 字符处理工具函数
- `tests/test_subtitle/` - 字幕模块测试
- `tests/fixtures/sample_srt/` - 测试用SRT样本文件

## Dependencies
- **Depends on**: Task 003 (Whisper语音识别), Task 004 (本地LLM翻译)
- **Input**: Whisper生成的原始SRT + 翻译结果
- **Output**: 标准双语SRT文件

## Testing Strategy
- **格式测试**: 生成SRT文件的格式规范性检查
- **播放器测试**: 多个播放器的兼容性验证
- **字符测试**: 各语言字符正确显示和长度限制
- **质量测试**: 时间轴精度和显示效果人工评估
- **边界测试**: 极长字幕、特殊字符、时间边界情况

## Estimated Effort
**Size**: M (2-3 days)
- Day 1: SRT解析器和标准格式化实现
- Day 2: 双语布局和字符限制功能
- Day 3: 质量检查和播放器兼容性测试

## Integration Points
- **输入接口**: 从Task 003获取原始SRT，从Task 004获取翻译结果
- **输出接口**: 为Task 006提供字幕数据结构
- **配置接口**: 支持用户自定义输出格式和布局选项

## Quality Standards
- **时间精度**: 时间轴误差 < 0.1秒
- **格式合规**: 100%符合SRT标准
- **字符准确**: 正确处理所有Unicode字符
- **可读性**: 字幕长度和断行符合观看习惯

## Notes
- 这是核心集成任务，质量直接影响最终用户体验
- 需要等待STT和翻译模块完成后才能开始
- 重点关注不同语言的显示特性和字符计算方式
